<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù‚ØµØ± Ø§Ù„Ø°Ù‡Ø¨ â€” Ø§Ù„Ù…Ø´Ø±Ù</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      font-family: 'Segoe UI', Tahoma, sans-serif;
      color: #fff;
      padding: 20px 16px 80px;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 22px;
    }
    h1 { color: #d4af37; font-size: 20px; }
    .logout-btn {
      background: transparent; border: 1px solid #d4af37;
      color: #d4af37; padding: 6px 14px; border-radius: 8px;
      cursor: pointer; font-size: 13px;
    }
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
    .tab {
      flex: 1; padding: 10px; border-radius: 10px;
      border: 1px solid rgba(212,175,55,0.3);
      background: rgba(255,255,255,0.04);
      color: #ccc; font-size: 14px; cursor: pointer; text-align: center;
      transition: all 0.2s;
    }
    .tab.active {
      background: rgba(212,175,55,0.2);
      border-color: #d4af37; color: #d4af37;
    }
    .stats-grid {
      display: grid; grid-template-columns: repeat(2,1fr);
      gap: 12px; margin-bottom: 20px;
    }
    .stat-card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 14px; padding: 16px; text-align: center;
    }
    .stat-card .val { font-size: 18px; font-weight: bold; color: #d4af37; }
    .stat-card .lbl { font-size: 11px; color: #aaa; margin-top: 4px; }
    .chart-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 14px; padding: 16px; margin-bottom: 14px;
    }
    .chart-card h3 { color: #d4af37; font-size: 13px; margin-bottom: 12px; }
    .filters {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 14px; padding: 18px; margin-bottom: 20px;
    }
    .filters h3 { color: #d4af37; font-size: 14px; margin-bottom: 14px; }
    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .filter-grid select, .filter-grid input {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 8px; color: #fff;
      padding: 9px 12px; font-size: 13px; width: 100%; outline: none;
    }
    option { background: #24243e; }
    .filter-full { grid-column: 1 / -1; }
    .date-range { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .date-range label { font-size: 11px; color: #aaa; margin-bottom: 4px; display: block; }
    .reset-btn {
      width: 100%; background: transparent;
      border: 1px solid rgba(212,175,55,0.4);
      color: #d4af37; padding: 9px; border-radius: 8px;
      cursor: pointer; font-size: 13px; margin-top: 4px;
    }
    .tx-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.12);
      border-radius: 12px; padding: 14px; margin-bottom: 10px;
    }
    .tx-top { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .tx-sell { color: #2ed573; font-weight: bold; }
    .tx-buy  { color: #ff4757; font-weight: bold; }
    .tx-detail { color: #bbb; font-size: 12px; line-height: 1.8; }
    .tx-amount { color: #d4af37; font-weight: bold; margin-top: 4px; }
    .tx-worker { color: #a29bfe; font-size: 12px; margin-bottom: 4px; }
    .badge {
      background: rgba(212,175,55,0.15);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 6px; font-size: 11px;
      padding: 2px 8px; color: #d4af37;
    }
    #noResults {
      color: #888; text-align: center;
      padding: 30px; display: none;
    }
    .section-title {
      color: #d4af37; font-size: 15px;
      font-weight: bold; margin-bottom: 14px;
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</h1>
    <span style="color:#aaa;font-size:11px;" id="lastUpdate"></span>
  </div>
  <button class="logout-btn" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="overview">ğŸ“ˆ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</div>
  <div class="tab" data-tab="transactions">ğŸ“‹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
</div>

<!-- Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© -->
<div id="tab-overview">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="val" id="st-sell">â€”</div>
      <div class="lbl">ğŸ’š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹ (ï·¼)</div>
    </div>
    <div class="stat-card">
      <div class="val" id="st-buy">â€”</div>
      <div class="lbl">â¤ï¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡ (ï·¼)</div>
    </div>
    <div class="stat-card">
      <div class="val" id="st-net">â€”</div>
      <div class="lbl">âš–ï¸ Ø§Ù„ØµØ§ÙÙŠ (ï·¼)</div>
    </div>
    <div class="stat-card">
      <div class="val" id="st-weight">â€”</div>
      <div class="lbl">âš–ï¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ²Ù† (Ø¬Ù…)</div>
    </div>
    <div class="stat-card">
      <div class="val" id="st-count">â€”</div>
      <div class="lbl">ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
    </div>
    <div class="stat-card">
      <div class="val" id="st-workers">â€”</div>
      <div class="lbl">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
    </div>
  </div>

  <div class="chart-card">
    <h3>ğŸ“Š Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ (Ø¢Ø®Ø± 14 ÙŠÙˆÙ…)</h3>
    <canvas id="chartDaily" height="200"></canvas>
  </div>
  <div class="chart-card">
    <h3>ğŸ’³ ØªÙˆØ²ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</h3>
    <canvas id="chartPay" height="200"></canvas>
  </div>
  <div class="chart-card">
    <h3>ğŸ¥‡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹ÙŠØ§Ø±Ø§Øª</h3>
    <canvas id="chartKarat" height="200"></canvas>
  </div>
  <div class="chart-card">
    <h3>ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø¹Ø§Ù…Ù„ (ï·¼)</h3>
    <canvas id="chartWorker" height="200"></canvas>
  </div>
</div>

<!-- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
<div id="tab-transactions" style="display:none;">
  <div class="filters">
    <h3>ğŸ” ÙÙ„ØªØ±Ø©</h3>
    <div class="filter-grid">
      <select id="f-worker"><option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ø§Ù„</option></select>
      <select id="f-type">
        <option value="">Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡</option>
        <option value="sell">Ø¨ÙŠØ¹ ÙÙ‚Ø·</option>
        <option value="buy">Ø´Ø±Ø§Ø¡ ÙÙ‚Ø·</option>
      </select>
      <select id="f-karat">
        <option value="">ÙƒÙ„ Ø§Ù„Ø¹ÙŠØ§Ø±Ø§Øª</option>
        <option>18</option><option>21</option><option>18&21</option>
      </select>
      <select id="f-product">
        <option value="">ÙƒÙ„ Ø§Ù„Ù‚Ø·Ø¹</option>
        <option>Ø³Ø¨Ø­Ø©</option><option>Ø®Ø§ØªÙ…</option><option>Ø¥Ø³ÙˆØ§Ø±Ø©</option>
        <option>Ø·Ù‚Ù…</option><option>Ù†Øµ Ø·Ù‚Ù…</option><option>Ø­Ù„Ù‚</option>
        <option>Ø¯Ø¨Ù„Ø©</option><option>Ø¹Ù‚Ø¯</option><option>Ø´ÙˆÙƒØ±</option>
        <option>Ø®Ù„Ø®Ø§Ù„</option><option>ÙƒÙ</option><option>Ø­Ø²Ø§Ù…</option>
      </select>
      <select id="f-pay">
        <option value="">ÙƒÙ„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</option>
        <option>ÙƒØ§Ø´</option><option>ØªØ­ÙˆÙŠÙ„</option><option>Ø¨Ø·Ø§Ù‚Ø©</option>
        <option>ØªØ§Ø¨ÙŠ</option><option>Ù†Øµ ÙƒØ§Ø´ Ù†Øµ ÙƒØ§Ø±Øª</option>
      </select>
      <div></div>
      <div class="filter-full">
        <div class="date-range">
          <div>
            <label>Ù…Ù†</label>
            <input type="date" id="f-from"/>
          </div>
          <div>
            <label>Ø¥Ù„Ù‰</label>
            <input type="date" id="f-to"/>
          </div>
        </div>
      </div>
      <button class="reset-btn filter-full" id="resetFilters">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
    </div>
  </div>

  <div class="section-title" id="txCount">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
  <div id="txList"></div>
  <div id="noResults">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙÙ„Ø§ØªØ±</div>
</div>

<script type="module">
  import { auth, db } from './firebase.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import {
    collection, query, orderBy, onSnapshot, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  let allTx = [];
  let charts = {};

  // Auth
  onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href = 'index.html'; return; }
    const snap = await getDoc(doc(db, 'workers', user.uid));
    if (!snap.exists() || snap.data().role !== 'admin') {
      alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø´Ø±Ù');
      window.location.href = 'index.html';
      return;
    }
    loadAll();
  });

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await signOut(auth);
    localStorage.clear();
    window.location.href = 'index.html';
  });

  // ØªØ¨ÙˆÙŠØ¨Ø§Øª
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const name = tab.dataset.tab;
      document.getElementById('tab-overview').style.display     = name==='overview'     ? 'block' : 'none';
      document.getElementById('tab-transactions').style.display = name==='transactions' ? 'block' : 'none';
    });
  });

  // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
  function loadAll() {
    const q = query(collection(db,'transactions'), orderBy('createdAt','desc'));
    onSnapshot(q, snap => {
      allTx = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      document.getElementById('lastUpdate').textContent =
        'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + new Date().toLocaleTimeString('ar-SA',
          {hour:'2-digit', minute:'2-digit'});
      updateStats(allTx);
      updateCharts(allTx);
      populateWorkers(allTx);
      applyFilters();
    });
  }

  // Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
  function updateStats(data) {
    const sells      = data.filter(t => t.type==='sell');
    const buys       = data.filter(t => t.type==='buy');
    const totalSell  = sells.reduce((a,t) => a+(t.amount||0), 0);
    const totalBuy   = buys.reduce((a,t)  => a+(t.amount||0), 0);
    const net        = totalSell - totalBuy;
    const totalW     = data.reduce((a,t)  => a+(t.weight||0), 0);
    const workers    = new Set(data.map(t => t.workerId)).size;

    document.getElementById('st-sell').textContent   = totalSell.toLocaleString('ar-SA') + ' ï·¼';
    document.getElementById('st-buy').textContent    = totalBuy.toLocaleString('ar-SA')  + ' ï·¼';
    const netEl = document.getElementById('st-net');
    netEl.textContent   = (net>=0?'+':'') + net.toLocaleString('ar-SA') + ' ï·¼';
    netEl.style.color   = net>=0 ? '#2ed573' : '#ff4757';
    document.getElementById('st-weight').textContent = totalW.toFixed(2) + ' Ø¬Ù…';
    document.getElementById('st-count').textContent  = data.length;
    document.getElementById('st-workers').textContent = workers;
  }

  // Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©
  function updateCharts(data) {
    // ÙŠÙˆÙ…ÙŠ
    const byDay = {};
    data.forEach(t => {
      if (!t.createdAt) return;
      const d = t.createdAt.toDate().toLocaleDateString('ar-SA-u-nu-latn');
      if (!byDay[d]) byDay[d] = {sell:0, buy:0};
      if (t.type==='sell') byDay[d].sell += t.amount||0;
      else byDay[d].buy += t.amount||0;
    });
    const days = Object.keys(byDay).slice(0,14).reverse();
    draw('chartDaily','bar',{
      labels: days,
      datasets:[
        {label:'Ø¨ÙŠØ¹', data:days.map(d=>byDay[d].sell), backgroundColor:'rgba(46,213,115,0.7)'},
        {label:'Ø´Ø±Ø§Ø¡', data:days.map(d=>byDay[d].buy), backgroundColor:'rgba(255,71,87,0.7)'}
      ]
    });

    // Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹
    const byPay = {};
    data.forEach(t => { byPay[t.payMethod]=(byPay[t.payMethod]||0)+1; });
    draw('chartPay','doughnut',{
      labels: Object.keys(byPay),
      datasets:[{ data:Object.values(byPay),
        backgroundColor:['#d4af37','#2ed573','#a29bfe','#ff6b6b','#74b9ff'] }]
    });

    // Ø§Ù„Ø¹ÙŠØ§Ø±Ø§Øª
    const byK = {};
    data.forEach(t => { byK[t.karat]=(byK[t.karat]||0)+1; });
    draw('chartKarat','pie',{
      labels: Object.keys(byK),
      datasets:[{ data:Object.values(byK),
        backgroundColor:['#d4af37','#74b9ff','#fd79a8'] }]
    });

    // Ø§Ù„Ø¹Ù…Ø§Ù„
    const byW = {};
    data.forEach(t => { byW[t.workerName]=(byW[t.workerName]||0)+(t.amount||0); });
    draw('chartWorker','bar',{
      labels: Object.keys(byW),
      datasets:[{ label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ ï·¼', data:Object.values(byW), backgroundColor:'#a29bfe' }]
    });
  }

  function draw(id, type, data) {
    const ctx = document.getElementById(id).getContext('2d');
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(ctx, {
      type, data,
      options:{
        responsive:true,
        plugins:{ legend:{ labels:{ color:'#ccc', font:{size:11} } } },
        scales: type==='bar' ? {
          x:{ ticks:{color:'#aaa'}, grid:{color:'rgba(255,255,255,0.05)'} },
          y:{ ticks:{color:'#aaa'}, grid:{color:'rgba(255,255,255,0.05)'} }
        } : {}
      }
    });
  }

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ ÙÙŠ Ø§Ù„ÙÙ„ØªØ±
  function populateWorkers(data) {
    const sel = document.getElementById('f-worker');
    const cur = sel.value;
    const map = {};
    data.forEach(t => { map[t.workerId]=t.workerName; });
    sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ø§Ù„</option>';
    Object.entries(map).forEach(([id,name]) => {
      const o=document.createElement('option');
      o.value=id; o.textContent=name;
      if(id===cur) o.selected=true;
      sel.appendChild(o);
    });
  }

  // ÙÙ„ØªØ±Ø©
  ['f-worker','f-type','f-karat','f-product','f-pay','f-from','f-to'].forEach(id => {
    document.getElementById(id).addEventListener('change', applyFilters);
  });
  document.getElementById('resetFilters').addEventListener('click', () => {
    ['f-worker','f-type','f-karat','f-product','f-pay','f-from','f-to']
      .forEach(id => { document.getElementById(id).value=''; });
    applyFilters();
  });

  function applyFilters() {
    const fw  = document.getElementById('f-worker').value;
    const ft  = document.getElementById('f-type').value;
    const fk  = document.getElementById('f-karat').value;
    const fp  = document.getElementById('f-product').value;
    const fpm = document.getElementById('f-pay').value;
    const fd1 = document.getElementById('f-from').value;
    const fd2 = document.getElementById('f-to').value;

    const filtered = allTx.filter(t => {
      if (fw  && t.workerId  !== fw)  return false;
      if (ft  && t.type      !== ft)  return false;
      if (fk  && t.karat     !== fk)  return false;
      if (fp  && t.product   !== fp)  return false;
      if (fpm && t.payMethod !== fpm) return false;
      if (fd1 || fd2) {
        const d = t.createdAt?.toDate();
        if (!d) return false;
        const ds = d.toISOString().slice(0,10);
        if (fd1 && ds < fd1) return false;
        if (fd2 && ds > fd2) return false;
      }
      return true;
    });
    renderTx(filtered);
  }

  function renderTx(data) {
    const list  = document.getElementById('txList');
    const noRes = document.getElementById('noResults');
    document.getElementById('txCount').textContent = `Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (${data.length})`;
    list.innerHTML = '';
    if (data.length===0) { noRes.style.display='block'; return; }
    noRes.style.display='none';
    data.forEach(t => {
      const isSell = t.type==='sell';
      const dt = t.createdAt?.toDate();
      const dtStr = dt ? dt.toLocaleString('ar-SA-u-nu-latn',{
        year:'numeric', month:'short', day:'numeric',
        hour:'2-digit', minute:'2-digit'
      }) : 'â€”';
      const el = document.createElement('div');
      el.className='tx-card';
      el.innerHTML=`
        <div class="tx-top">
          <span class="${isSell?'tx-sell':'tx-buy'}">${isSell?'ğŸ“¤ Ø¨ÙŠØ¹':'ğŸ“¥ Ø´Ø±Ø§Ø¡'}</span>
          <span class="badge">${t.karat} Ø¹ÙŠØ§Ø±</span>
        </div>
        <div class="tx-worker">ğŸ‘¤ ${t.workerName||'â€”'}</div>
        <div class="tx-detail">
          ${isSell?'Ø§Ù„Ù‚Ø·Ø¹Ø©: '+t.product:'Ù†ÙˆØ¹ Ø§Ù„Ø°Ù‡Ø¨: '+t.goldType} |
          Ø§Ù„ÙˆØ²Ù†: ${t.weight}Ø¬Ù… | Ø§Ù„Ø¯ÙØ¹: ${t.payMethod}
          ${t.notes?'<br>ğŸ“ '+t.notes:''}
          <br>ğŸ• ${dtStr}
        </div>
        <div class="tx-amount">${(t.amount||0).toLocaleString('ar-SA')} ï·¼</div>
      `;
      list.appendChild(el);
    });
  }
</script>
</body>
</html>
