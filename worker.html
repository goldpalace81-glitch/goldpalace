<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù‚ØµØ± Ø§Ù„Ø°Ù‡Ø¨ â€” Ø§Ù„Ø¹Ø§Ù…Ù„</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      font-family: 'Segoe UI', Tahoma, sans-serif;
      color: #fff;
      padding: 20px 16px 80px;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 24px;
    }
    header h1 { color: #d4af37; font-size: 20px; }
    .logout-btn {
      background: transparent;
      border: 1px solid #d4af37;
      color: #d4af37;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }
    .type-btns {
      display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
      margin-bottom: 28px;
    }
    .type-btn {
      padding: 22px 10px;
      border-radius: 14px;
      border: 2px solid transparent;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.25s;
    }
    .type-btn.sell {
      background: rgba(46,213,115,0.1);
      border-color: rgba(46,213,115,0.4);
      color: #2ed573;
    }
    .type-btn.buy {
      background: rgba(255,71,87,0.1);
      border-color: rgba(255,71,87,0.4);
      color: #ff4757;
    }
    .type-btn.selected {
      transform: scale(1.04);
      box-shadow: 0 0 24px rgba(212,175,55,0.4);
      border-color: #d4af37 !important;
      color: #d4af37 !important;
    }
    .form-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 16px;
      padding: 22px;
      margin-bottom: 20px;
    }
    .field { margin-bottom: 20px; }
    label {
      display: block;
      color: #d4af37;
      font-size: 13px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    select, input[type="number"], input[type="text"], textarea {
      width: 100%;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 10px;
      color: #fff;
      font-size: 15px;
      padding: 12px 14px;
      outline: none;
      transition: border 0.3s;
      -webkit-appearance: none;
    }
    select:focus, input:focus, textarea:focus { border-color: #d4af37; }
    option { background: #24243e; color: #fff; }
    .karat-group { display: flex; gap: 10px; }
    .karat-pill {
      flex: 1;
      padding: 11px 0;
      border-radius: 10px;
      border: 2px solid rgba(212,175,55,0.3);
      background: rgba(255,255,255,0.05);
      color: #aaa;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .karat-pill.selected {
      background: linear-gradient(135deg, #d4af37, #b8972e);
      color: #1a1200;
      border-color: #d4af37;
      box-shadow: 0 0 14px rgba(212,175,55,0.5);
    }
    .radio-group { display: flex; gap: 10px; }
    .radio-btn {
      flex: 1;
      padding: 11px;
      border-radius: 10px;
      border: 2px solid rgba(212,175,55,0.3);
      background: rgba(255,255,255,0.05);
      color: #aaa;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .radio-btn.selected {
      background: rgba(212,175,55,0.2);
      border-color: #d4af37;
      color: #d4af37;
    }
    .half-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    textarea { resize: none; min-height: 80px; }
    .datetime-badge {
      background: rgba(212,175,55,0.08);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 13px;
      color: #d4af37;
      text-align: center;
    }
    .save-btn {
      width: 100%;
      background: linear-gradient(135deg, #d4af37, #b8972e);
      color: #1a1200;
      font-size: 17px;
      font-weight: bold;
      padding: 15px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    .save-btn:hover { opacity: 0.88; }
    .save-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    #toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: #2ed573; color: #000; padding: 12px 28px;
      border-radius: 30px; font-weight: bold; font-size: 14px;
      opacity: 0; transition: opacity 0.4s; pointer-events: none; z-index: 999;
    }
    #toast.show { opacity: 1; }
    #toast.error { background: #ff4757; color: #fff; }
    .history-title { color: #d4af37; font-size: 16px; font-weight: bold; margin: 28px 0 14px; }
    .tx-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.12);
      border-radius: 12px; padding: 14px 16px; margin-bottom: 10px;
    }
    .tx-top { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .tx-sell { color: #2ed573; font-weight: bold; }
    .tx-buy { color: #ff4757; font-weight: bold; }
    .tx-detail { color: #bbb; font-size: 13px; line-height: 1.8; }
    .tx-amount { color: #d4af37; font-weight: bold; font-size: 15px; margin-top: 4px; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>ğŸ… Ù‚ØµØ± Ø§Ù„Ø°Ù‡Ø¨</h1>
    <span style="color:#aaa;font-size:13px;" id="workerNameHeader"></span>
  </div>
  <button class="logout-btn" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
</header>

<div class="type-btns">
  <button class="type-btn sell" data-type="sell">ğŸ“¤ Ø¨ÙŠØ¹</button>
  <button class="type-btn buy"  data-type="buy">ğŸ“¥ Ø´Ø±Ø§Ø¡</button>
</div>

<div class="form-card" id="mainForm" style="display:none;">

  <div class="field">
    <label>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
    <div class="datetime-badge" id="datetimeDisplay"></div>
  </div>

  <div class="field" id="productField">
    <label>ğŸ’ Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
    <select id="product">
      <option value="">â€” Ø§Ø®ØªØ± â€”</option>
      <option>Ø³Ø¨Ø­Ø©</option><option>Ø®Ø§ØªÙ…</option><option>Ø¥Ø³ÙˆØ§Ø±Ø©</option>
      <option>Ø·Ù‚Ù…</option><option>Ù†Øµ Ø·Ù‚Ù…</option><option>Ø­Ù„Ù‚</option>
      <option>Ø¯Ø¨Ù„Ø©</option><option>Ø¹Ù‚Ø¯</option><option>Ø´ÙˆÙƒØ±</option>
      <option>Ø®Ù„Ø®Ø§Ù„</option><option>ÙƒÙ</option><option>Ø­Ø²Ø§Ù…</option>
    </select>
  </div>

  <div class="field">
    <label>âš–ï¸ Ø§Ù„Ø¹ÙŠØ§Ø±</label>
    <div class="karat-group">
      <div class="karat-pill" data-karat="18">18</div>
      <div class="karat-pill" data-karat="21">21</div>
      <div class="karat-pill" data-karat="18&21">18&21</div>
    </div>
    <input type="hidden" id="karatVal"/>
  </div>

  <div class="field" id="goldTypeField" style="display:none;">
    <label>ğŸ”¸ Ù†ÙˆØ¹ Ø§Ù„Ø°Ù‡Ø¨ <span style="color:#ff4757;font-size:11px;">(Ù…Ø·Ù„ÙˆØ¨)</span></label>
    <div class="radio-group">
      <div class="radio-btn" data-gtype="Ø°Ù‡Ø¨ ØµØ§ÙÙ">Ø°Ù‡Ø¨ ØµØ§ÙÙ</div>
      <div class="radio-btn" data-gtype="Ø°Ù‡Ø¨ Ø¨ÙØµÙˆØµ">Ø¨ÙØµÙˆØµ</div>
    </div>
    <input type="hidden" id="goldTypeVal"/>
  </div>

  <div class="field">
    <label>âš–ï¸ Ø§Ù„ÙˆØ²Ù† (Ø¬Ø±Ø§Ù…)</label>
    <input type="number" id="weight" placeholder="0.00" step="0.01" min="0"/>
  </div>

  <div class="field">
    <label>ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
    <select id="payMethod">
      <option value="">â€” Ø§Ø®ØªØ± â€”</option>
    </select>
  </div>

  <div class="field" id="amountField">
    <label>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº (ï·¼)</label>
    <input type="number" id="amount" placeholder="0" min="0"/>
  </div>

  <div class="half-grid" id="halfFields" style="display:none;">
    <div>
      <label>ğŸ’µ Ù†Ù‚Ø¯ÙŠ (ï·¼)</label>
      <input type="number" id="amountCash" placeholder="0" min="0"/>
    </div>
    <div>
      <label>ğŸ’³ ÙƒØ§Ø±Øª (ï·¼)</label>
      <input type="number" id="amountCard" placeholder="0" min="0"/>
    </div>
  </div>

  <div class="field">
    <label>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© <span style="color:#888;font-size:11px;">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
    <textarea id="notes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
  </div>

  <button class="save-btn" id="saveBtn">âœ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
</div>

<div id="historySection" style="display:none;">
  <div class="history-title">ğŸ“‹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
  <div id="historyList"></div>
</div>

<div id="toast"></div>

<script type="module">
  import { auth, db } from './firebase.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import {
    collection, addDoc, query, where, orderBy,
    onSnapshot, serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  let currentUser = null;
  let currentType = null;

  onAuthStateChanged(auth, user => {
    if (!user) { window.location.href = 'index.html'; return; }
    currentUser = user;
    document.getElementById('workerNameHeader').textContent =
      'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' + (localStorage.getItem('gp_name') || '');
    loadToday();
  });

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await signOut(auth);
    localStorage.clear();
    window.location.href = 'index.html';
  });

  // Ø³Ø§Ø¹Ø©
  function tick() {
    const now = new Date();
    document.getElementById('datetimeDisplay').textContent =
      now.toLocaleDateString('ar-SA-u-nu-latn', {
        weekday:'long', year:'numeric', month:'long', day:'numeric',
        hour:'2-digit', minute:'2-digit', hour12:true, timeZone:'Asia/Riyadh'
      });
  }
  setInterval(tick, 1000); tick();

  // Ø§Ø®ØªÙŠØ§Ø± Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡
  document.querySelectorAll('.type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      currentType = btn.dataset.type;
      document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('mainForm').style.display = 'block';
      buildForm(currentType);
    });
  });

  function buildForm(type) {
    const isBuy = type === 'buy';
    document.getElementById('productField').style.display  = isBuy ? 'none'  : 'block';
    document.getElementById('goldTypeField').style.display = isBuy ? 'block' : 'none';
    const pm = document.getElementById('payMethod');
    pm.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>';
    const methods = isBuy
      ? ['ÙƒØ§Ø´', 'ØªØ­ÙˆÙŠÙ„']
      : ['ÙƒØ§Ø´', 'ØªØ­ÙˆÙŠÙ„', 'Ø¨Ø·Ø§Ù‚Ø©', 'ØªØ§Ø¨ÙŠ', 'Ù†Øµ ÙƒØ§Ø´ Ù†Øµ ÙƒØ§Ø±Øª'];
    methods.forEach(m => {
      const o = document.createElement('option');
      o.value = m; o.textContent = m; pm.appendChild(o);
    });
    refreshPayFields();
  }

  function refreshPayFields() {
    const isHalf = document.getElementById('payMethod').value === 'Ù†Øµ ÙƒØ§Ø´ Ù†Øµ ÙƒØ§Ø±Øª';
    document.getElementById('amountField').style.display = isHalf ? 'none'  : 'block';
    document.getElementById('halfFields').style.display  = isHalf ? 'grid'  : 'none';
  }
  document.getElementById('payMethod').addEventListener('change', refreshPayFields);

  // Ø§Ù„Ø¹ÙŠØ§Ø±Ø§Øª
  document.querySelectorAll('.karat-pill').forEach(p => {
    p.addEventListener('click', () => {
      document.querySelectorAll('.karat-pill').forEach(x => x.classList.remove('selected'));
      p.classList.add('selected');
      document.getElementById('karatVal').value = p.dataset.karat;
    });
  });

  // Ù†ÙˆØ¹ Ø§Ù„Ø°Ù‡Ø¨
  document.querySelectorAll('.radio-btn').forEach(b => {
    b.addEventListener('click', () => {
      document.querySelectorAll('.radio-btn').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected');
      document.getElementById('goldTypeVal').value = b.dataset.gtype;
    });
  });

  // Ø­ÙØ¸
  document.getElementById('saveBtn').addEventListener('click', async () => {
    if (!currentUser || !currentType) return;
    const isBuy   = currentType === 'buy';
    const karat   = document.getElementById('karatVal').value;
    const weight  = parseFloat(document.getElementById('weight').value);
    const pay     = document.getElementById('payMethod').value;
    const notes   = document.getElementById('notes').value.trim();
    const product = document.getElementById('product').value;
    const gtype   = document.getElementById('goldTypeVal').value;
    const isHalf  = pay === 'Ù†Øµ ÙƒØ§Ø´ Ù†Øµ ÙƒØ§Ø±Øª';

    if (!karat)               return toast('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ø¹ÙŠØ§Ø±', true);
    if (isBuy && !gtype)      return toast('âš ï¸ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø°Ù‡Ø¨', true);
    if (!isBuy && !product)   return toast('âš ï¸ Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©', true);
    if (!weight || weight<=0) return toast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ²Ù†', true);
    if (!pay)                 return toast('âš ï¸ Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', true);

    let amount = 0, amountCash = 0, amountCard = 0;
    if (isHalf) {
      amountCash = parseFloat(document.getElementById('amountCash').value) || 0;
      amountCard = parseFloat(document.getElementById('amountCard').value) || 0;
      amount = amountCash + amountCard;
      if (amount <= 0) return toast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº', true);
    } else {
      amount = parseFloat(document.getElementById('amount').value) || 0;
      if (amount <= 0) return toast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº', true);
    }

    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

    try {
      await addDoc(collection(db, 'transactions'), {
        workerId:   currentUser.uid,
        workerName: localStorage.getItem('gp_name') || '',
        type:       currentType,
        karat, weight, payMethod: pay, amount, notes,
        product:    isBuy ? null : product,
        goldType:   isBuy ? gtype : null,
        amountCash: isHalf ? amountCash : null,
        amountCard: isHalf ? amountCard : null,
        createdAt:  serverTimestamp()
      });
      toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
      resetForm();
    } catch(e) {
      toast('âŒ ' + e.message, true);
    } finally {
      btn.disabled = false; btn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
    }
  });

  function resetForm() {
    ['product','karatVal','goldTypeVal','weight','payMethod',
     'amount','amountCash','amountCard','notes'].forEach(id => {
      document.getElementById(id).value = '';
    });
    document.querySelectorAll('.karat-pill,.radio-btn').forEach(x => x.classList.remove('selected'));
    document.getElementById('halfFields').style.display  = 'none';
    document.getElementById('amountField').style.display = 'block';
    document.getElementById('mainForm').style.display    = 'none';
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
    currentType = null;
  }

  // Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…
  function loadToday() {
    const start = new Date(); start.setHours(0,0,0,0);
    const end   = new Date(); end.setHours(23,59,59,999);
    const q = query(
      collection(db,'transactions'),
      where('workerId','==', currentUser.uid),
      where('createdAt','>=', Timestamp.fromDate(start)),
      where('createdAt','<=', Timestamp.fromDate(end)),
      orderBy('createdAt','desc')
    );
    onSnapshot(q, snap => {
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      document.getElementById('historySection').style.display = snap.empty ? 'none' : 'block';
      snap.forEach(d => {
        const t = d.data();
        const isSell = t.type === 'sell';
        const time = t.createdAt?.toDate().toLocaleTimeString('ar-SA',
          {hour:'2-digit', minute:'2-digit'}) || '';
        const el = document.createElement('div');
        el.className = 'tx-card';
        el.innerHTML = `
          <div class="tx-top">
            <span class="${isSell?'tx-sell':'tx-buy'}">${isSell?'ğŸ“¤ Ø¨ÙŠØ¹':'ğŸ“¥ Ø´Ø±Ø§Ø¡'}</span>
            <span style="color:#888;font-size:12px;">${time}</span>
          </div>
          <div class="tx-detail">
            ${isSell ? 'Ø§Ù„Ù‚Ø·Ø¹Ø©: '+t.product : 'Ù†ÙˆØ¹: '+t.goldType} |
            Ø§Ù„Ø¹ÙŠØ§Ø±: ${t.karat} | Ø§Ù„ÙˆØ²Ù†: ${t.weight}Ø¬Ù…<br>
            Ø§Ù„Ø¯ÙØ¹: ${t.payMethod}
            ${t.notes ? ' | '+t.notes : ''}
          </div>
          <div class="tx-amount">${(t.amount||0).toLocaleString('ar-SA')} ï·¼</div>
        `;
        list.appendChild(el);
      });
    });
  }

  function toast(msg, err=false) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = err ? 'show error' : 'show';
    setTimeout(() => { t.className = ''; }, 3000);
  }
</script>
</body>
</html>
